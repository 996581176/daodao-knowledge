<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>百度地图点聚合点击事件卡顿问题解决 | 刀刀的知识积累</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script>var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?6371333d39195dbe958ef14c0a722ac4";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
            })();</script>
    <link rel="icon" href="/daodao-knowledge/img/newlogo.ico">
    <meta name="description" content="立志不再懒懒散散的小前端的知识库">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/daodao-knowledge/assets/css/0.styles.d20051cc.css" as="style"><link rel="preload" href="/daodao-knowledge/assets/js/app.b053aef9.js" as="script"><link rel="preload" href="/daodao-knowledge/assets/js/8.169c5c8d.js" as="script"><link rel="preload" href="/daodao-knowledge/assets/js/9.d9308caa.js" as="script"><link rel="preload" href="/daodao-knowledge/assets/js/134.0fe7afbd.js" as="script"><link rel="prefetch" href="/daodao-knowledge/assets/js/1.82efe308.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/10.f75fe4c0.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/100.0e0fed5a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/101.17db3ec7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/102.ba3fc976.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/103.d965b512.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/104.2b2bfaf1.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/105.abede1e2.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/106.e0609f6f.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/107.dd51a49c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/108.d3318b96.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/109.271ec338.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/11.22cbe312.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/110.4e14282c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/111.2902a4f9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/112.69251a72.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/113.1abb6ab1.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/114.b4ccc05c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/115.e74cedaf.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/116.8495b573.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/117.af36a4bd.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/118.353b70b8.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/119.63839c76.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/12.aa8cd978.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/120.dcf53bec.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/121.9497168f.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/122.fefea9c2.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/123.66d2492a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/124.968d585b.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/125.9b131169.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/126.0ea9bd58.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/127.39c52237.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/128.74d8e29c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/129.b8433544.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/13.ab27642c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/130.96f15f00.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/131.3701add9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/132.ef2f7fbb.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/133.85e8b964.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/135.03c37e9e.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/136.5630822c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/137.deaa6e39.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/138.ee32f57c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/139.ac5cd4d3.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/14.7745424a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/140.49454a30.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/141.1af55191.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/142.8520bb70.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/143.f27a6935.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/144.09eff01d.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/145.c21503fa.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/146.c5615670.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/147.7a0288a7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/148.5967c538.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/149.db0ba67a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/15.e4a9b95d.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/150.d68929d7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/151.367f3377.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/152.d52d03a8.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/153.16a38e5f.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/154.a395c19c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/155.fabc04d6.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/156.3707c9bb.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/157.15e2f816.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/158.c3993597.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/159.0bed6a16.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/16.95edcb59.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/160.055df2f7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/161.a2d226b1.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/162.848ddb6b.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/163.7af2fa82.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/164.1097b613.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/165.c869fad7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/166.321743ed.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/167.9cbe3931.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/168.adef1aa2.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/169.d3b2bc6b.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/17.5a42d200.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/170.e6b775d5.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/171.6d25d4a2.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/172.eed533f0.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/173.6780e349.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/174.e8e9ccb3.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/175.5331c3f9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/176.5bb7f1ad.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/177.d1a22626.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/178.435c5f71.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/179.79d032ae.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/18.9cdbdeb9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/180.48cb84aa.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/181.d38a2a0a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/182.0fcb2397.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/19.48d449e4.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/2.a58452e9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/20.d57a14e9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/21.69f40bf5.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/22.02835823.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/23.5567c7c9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/24.167bc9b6.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/25.aafe96b2.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/26.828eb19a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/27.ae45872a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/28.92175f39.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/29.78633728.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/3.58a7e0d3.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/30.1ab8e6b3.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/31.a65160f6.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/32.1eca5db6.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/33.89de1c9b.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/34.c3dd122f.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/35.0dcfee27.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/36.216360e7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/37.95365fb9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/38.43877a79.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/39.9ba262d6.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/4.9ce2758d.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/40.6327d5eb.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/41.3f7ce62a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/42.b2e1fb9e.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/43.891828ce.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/44.90b99214.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/45.2626235c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/46.63dd3e64.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/47.1a742118.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/48.26b56b18.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/49.c69591d1.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/5.4ee03279.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/50.5c9da7fe.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/51.dc192ea6.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/52.6b681925.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/53.13237707.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/54.72b53f89.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/55.b9e89d02.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/56.918b549d.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/57.6f21581f.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/58.0e2558cc.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/59.f4021f5a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/6.5db0296c.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/60.c78ae850.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/61.3fc26e62.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/62.96490e40.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/63.b913a808.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/64.ee83f829.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/65.d1c5ddf9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/66.7a6a708e.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/67.80f14c8b.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/68.229f2745.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/69.9eff1fdd.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/70.689c97e0.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/71.01a849b0.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/72.6f715f24.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/73.5cfba415.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/74.d1c92f91.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/75.2082b94d.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/76.f670c1e7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/77.f72002e0.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/78.f762ca6d.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/79.b0919cc7.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/80.5c5b97fb.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/81.a57525fb.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/82.03730b80.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/83.a1b35829.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/84.1c268ba0.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/85.50f2cbb8.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/86.7380178a.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/87.647056f9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/88.6d9f4587.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/89.251a95a1.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/90.9d9c3623.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/91.4df4c3d8.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/92.ab59f2f5.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/93.9e1748e9.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/94.93155e28.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/95.7ffb7d96.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/96.73b7f460.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/97.fc542675.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/98.227937ec.js"><link rel="prefetch" href="/daodao-knowledge/assets/js/99.567e672b.js">
    <link rel="stylesheet" href="/daodao-knowledge/assets/css/0.styles.d20051cc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/daodao-knowledge/" class="home-link router-link-active"><img src="/daodao-knowledge/img/home.jpg" alt="刀刀的知识积累" class="logo"> <span class="site-name can-hide">刀刀的知识积累</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/daodao-knowledge/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><span class="title">前端学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习" class="mobile-dropdown-title"><span class="title">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/600fd9/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/12e2d5/" class="nav-link">
  算法&amp;常用方法
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/450a09/" class="nav-link">
  TypeScript
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/ffc1d9/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/a5dbfb/" class="nav-link">
  现代JavaScript库开发
</a></li></ul></li><li class="dropdown-item"><h4>
          框架学习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/8ea889/" class="nav-link">
  react
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/3ba846/" class="nav-link">
  vuePress
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/347ae3/" class="nav-link">
  qiankun微前端
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/f97ef5/" class="nav-link">
  vue3
</a></li></ul></li><li class="dropdown-item"><h4>
          webgl学习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/7fb7ad/" class="nav-link">
  threejs
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/e77551/" class="nav-link">
  the book of shaders
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><span class="title">后端学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端学习" class="mobile-dropdown-title"><span class="title">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daodao-knowledge/pages/437984/" class="nav-link">
  python
</a></li></ul></div></div><div class="nav-item"><a href="/daodao-knowledge/pages/cd2a4f/" class="nav-link">
  零零碎碎
</a></div><div class="nav-item"><a href="/daodao-knowledge/pages/9d1205/" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><span class="title">索引</span> <span class="arrow down"></span></button> <button type="button" aria-label="索引" class="mobile-dropdown-title"><span class="title">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daodao-knowledge/archives/" class="nav-link">
  归档
</a></li></ul></div></div><div class="nav-item"><a href="/daodao-knowledge/daodao/" class="nav-link">
  关于我
</a></div> <a href="https://github.com/Ostask/daodao-knowledge" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/daodao-knowledge/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><span class="title">前端学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习" class="mobile-dropdown-title"><span class="title">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/600fd9/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/12e2d5/" class="nav-link">
  算法&amp;常用方法
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/450a09/" class="nav-link">
  TypeScript
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/ffc1d9/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/a5dbfb/" class="nav-link">
  现代JavaScript库开发
</a></li></ul></li><li class="dropdown-item"><h4>
          框架学习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/8ea889/" class="nav-link">
  react
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/3ba846/" class="nav-link">
  vuePress
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/347ae3/" class="nav-link">
  qiankun微前端
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/f97ef5/" class="nav-link">
  vue3
</a></li></ul></li><li class="dropdown-item"><h4>
          webgl学习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/7fb7ad/" class="nav-link">
  threejs
</a></li><li class="dropdown-subitem"><a href="/daodao-knowledge/pages/e77551/" class="nav-link">
  the book of shaders
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><span class="title">后端学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端学习" class="mobile-dropdown-title"><span class="title">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daodao-knowledge/pages/437984/" class="nav-link">
  python
</a></li></ul></div></div><div class="nav-item"><a href="/daodao-knowledge/pages/cd2a4f/" class="nav-link">
  零零碎碎
</a></div><div class="nav-item"><a href="/daodao-knowledge/pages/9d1205/" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><span class="title">索引</span> <span class="arrow down"></span></button> <button type="button" aria-label="索引" class="mobile-dropdown-title"><span class="title">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daodao-knowledge/archives/" class="nav-link">
  归档
</a></li></ul></div></div><div class="nav-item"><a href="/daodao-knowledge/daodao/" class="nav-link">
  关于我
</a></div> <a href="https://github.com/Ostask/daodao-knowledge" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>bug记录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/daodao-knowledge/pages/cd2a4f/" class="sidebar-link">element-ui的table在flex布局下宽度一直增大</a></li><li><a href="/daodao-knowledge/pages/e8f96f/" class="sidebar-link">threejs截屏为黑色问题</a></li><li><a href="/daodao-knowledge/pages/54d24a/" class="sidebar-link">骚操作！解决百度地图marker太多卡顿</a></li><li><a href="/daodao-knowledge/pages/a3beeb/" class="sidebar-link">translateZ引起的别的元素抖动问题</a></li><li><a href="/daodao-knowledge/pages/557831/" class="sidebar-link">elementUI 2x版本生产环境图标乱码</a></li><li><a href="/daodao-knowledge/pages/65571a/" class="sidebar-link">elementUI自定义弹窗zIndex问题</a></li><li><a href="/daodao-knowledge/pages/3a2331/" class="sidebar-link">nodejs报错digital envelope routines::unsupported</a></li><li><a href="/daodao-knowledge/pages/c0291f/" class="sidebar-link">canvas动画越来越卡顿解决</a></li><li><a href="/daodao-knowledge/pages/c65351/" aria-current="page" class="active sidebar-link">百度地图点聚合点击事件卡顿问题解决</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daodao-knowledge/pages/c65351/#遇到问题" class="sidebar-link">遇到问题</a></li><li class="sidebar-sub-header"><a href="/daodao-knowledge/pages/c65351/#梳理点聚合源码逻辑" class="sidebar-link">梳理点聚合源码逻辑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daodao-knowledge/pages/c65351/#点聚合源码结构" class="sidebar-link">点聚合源码结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/daodao-knowledge/pages/c65351/#排查bug" class="sidebar-link">排查bug</a></li><li class="sidebar-sub-header"><a href="/daodao-knowledge/pages/c65351/#完整代码" class="sidebar-link">完整代码</a></li></ul></li><li><a href="/daodao-knowledge/pages/5e5a48/" class="sidebar-link">canvas绘制网络图片执行toDataURL()报错</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>插件使用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>threejs相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发一方通行插件记录</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>echarts</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>百度地图</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack相关</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="page-content hasRightNav"><div class="right-nav" data-v-e3ddc674></div> <div class="article-title theme-default-content" data-v-fda27140><h1 data-v-fda27140><span class="circle" data-v-fda27140></span>百度地图点聚合点击事件卡顿问题解决</h1> <div class="lastUpdatedTime" data-v-fda27140><span class="text" data-v-fda27140>更新时间:</span> 2023-09-14 09:49:23</div></div> <div class="theme-default-content content__default"><h2 id="遇到问题"><a href="#遇到问题" class="header-anchor">#</a> 遇到问题</h2> <p>公司的新项目需要用到百度地图的点聚合功能，按照官网上的例子一顿抄自我感觉很良好，但是测试却报了bug，然后我打开页面一看，是这个样子的：
（图片录得有点大，耐心等一下哈）
<img src="https://daodaoblogpicgo.oss-cn-shanghai.aliyuncs.com/img/2023091401.gif" alt="">
点击点聚合图标的时候，竟然把我的程序卡死了，可以看到旁边原本运行流畅的动画也被卡得动不了。</p> <p>我以为是自己的问题，但打开官方例子将点改多了之后，也出现了同样的问题。</p> <p>好家伙，点聚合原本是解决点太多地图卡顿而存在的，没想到它自己先卡顿了，瞅了一眼源码也就600行，撸起袖子自己干吧,省时间可以翻到最后</p> <h2 id="梳理点聚合源码逻辑"><a href="#梳理点聚合源码逻辑" class="header-anchor">#</a> 梳理点聚合源码逻辑</h2> <p>一行一行读完源码后，我整理了一份思维导图：(按住ctrl加滚轮缩放哈)</p> <ul><li>红色是我改动了删除的部分</li> <li>绿色是我新增的部分</li> <li>黄色是我觉得效率低下可以优化的部分（不过我没改,不是我懒,突然又来活了没空哈）
<iframe src="https://gitmind.cn/app/docs/mog89i8q" style="width:100%;height:600px;border:none;"></iframe></li></ul> <h3 id="点聚合源码结构"><a href="#点聚合源码结构" class="header-anchor">#</a> 点聚合源码结构</h3> <p>源码一共分为三个大部分：</p> <ul><li>工具方法</li> <li><code>MarkerClusterer</code>类</li> <li><code>Cluster</code>类</li></ul> <p>其中工具方法没什么好说的，自己对着思维导图看一下就行了，是一些使用频率较高的方法</p> <p>因为这个库依赖于百度地图，所以一下所说的点或<code>marker</code>指的是 <code>BMap.Marker</code></p> <h4 id="markerclusterer类"><a href="#markerclusterer类" class="header-anchor">#</a> <code>MarkerClusterer</code>类</h4> <p><code>MarkerClusterer</code>类管理着地图上所有需要被聚合的点以及聚合点，这里我将源码的一部分贴出来,上面加上了我的注释：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> MarkerClusterer <span class="token operator">=</span> BMapLib<span class="token punctuation">.</span><span class="token function-variable function">MarkerClusterer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// map实例必传</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 地图实例</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map <span class="token operator">=</span> map
        <span class="token comment">// 普通点集合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">// 聚合点集合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment">// 处理一下传过来的参数</span>
        <span class="token keyword">var</span> opts <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_gridSize <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;gridSize&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">60</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_maxZoom <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;maxZoom&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">18</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;minClusterSize&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">[</span><span class="token string">&quot;isAverageCenter&quot;</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;isAverageCenter&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_styles <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;styles&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>

        <span class="token comment">// 监听地图 zoomend 事件和 moveend 事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;zoomend&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
            that<span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;moveend&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            that<span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">var</span> mkrs <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;markers&quot;</span><span class="token punctuation">]</span>
        <span class="token comment">// 学习：先做判断是不是数组，传入的参数很有必要做判断</span>
        <span class="token function">isArray</span><span class="token punctuation">(</span>mkrs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addMarkers</span><span class="token punctuation">(</span>mkrs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>可以看到<code>MarkerClusterer</code>其实就是将一些关键的参数储存作为属性，然后给地图绑定了<code>zoomend</code>和<code>moveend</code>事件，最后调用了<code>this.addMarkers</code>方法。</p> <p>而<code>MarkerClusterer</code>中的方法大概分为几大类：</p> <ul><li><p>改查各种属性的方法</p> <ul><li><code>getMap</code>（获取聚合的<code>Map</code>实例，即<code>_map</code>属性）</li> <li><code>getMarkers</code>（获取<code>this._markers</code>）</li> <li><code>getMinClusterSize</code> （获取单个聚合最小数量，即<code>_minClusterSize</code>）</li> <li><code>setMinClusterSize</code>（设置单个聚合最小数量）</li> <li><code>isAverageCenter</code> (获取单个聚合的落脚点是否是聚合内所有标记的平均中心,即<code>_isAverageCenter</code>)</li> <li><code>getStyles</code>(获取聚合的样式风格集合，即<code>_styles</code>)</li> <li><code>setStyles</code>(设置聚合的样式风格集合)</li> <li><code>getMaxZoom</code>(获取聚合的最大缩放级别,即 <code>_maxZoom</code>)</li> <li><code>setMaxZoom</code>（设置聚合最大缩放级别）</li> <li><code>getGridSize</code>（获取网格大小）</li> <li><code>setGridSize</code>（设置网格大小）</li> <li><code>getClustersCount</code>(获取真聚合的数量)</li></ul></li> <li><p>地图中需要被聚合的点的增删改查方法（这里比较清晰的点在于，并不在<code>MarkerClusterer</code>类中处理具体应该如何聚合的逻辑以及显示,具体的应该在<code>Cluster</code>类中实现）</p> <ul><li><code>addMarker</code>（将单个<code>marker</code>添加到聚合中）</li> <li><code>addMarkers</code>（将多个<code>marker</code>添加到聚合中）</li> <li><code>_pushMarkerTo</code>(处理并保存<code>markers</code>数组)</li> <li><code>_addToClosestCluster</code>（将点保存到最近的聚合点中）</li> <li><code>_removeMarker</code>(删除单个<code>marker</code>，该方法只是从数据层删除，并没有重绘聚合)</li> <li><code>removeMarker</code>（删除单个<code>marker</code>,并重绘聚合）</li> <li><code>removeMarkers</code>(删除一组<code>markers</code>,并重绘聚合)</li> <li><code>clearMarkers</code>（从地图上彻底清除所有标记）</li></ul></li> <li><p>渲染相关的方法</p> <ul><li><code>_createClusters</code>（创建所有聚合点）</li> <li><code>_redraw</code>（重新生成）</li> <li><code>_clearLastClusters</code>（清除上一次的聚合的结果）</li> <li><code>_removeMarkersFromCluster</code>（将所有<code>marker</code>的<code>isInCluster</code>属性改为<code>false</code>）</li> <li><code>_removeMarkersFromMap</code>（从地图上彻底清除所有散点）</li></ul></li></ul> <h4 id="cluster类"><a href="#cluster类" class="header-anchor">#</a> <code>Cluster</code>类</h4> <p><code>Cluster</code>是单个聚合点的类，它的代码我也加上了注释, 可以看到它的构造函数就只是初始化了一些属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Cluster</span><span class="token punctuation">(</span><span class="token parameter">markerClusterer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 总聚合markerClusterer实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer <span class="token operator">=</span> markerClusterer
    <span class="token keyword">this</span><span class="token punctuation">.</span>_map <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">getMinClusterSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">isAverageCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 落脚位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 这个Cluster中所包含的markers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_markers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 以中心点为准，向四边扩大gridSize个像素范围，即网格范围</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_gridBounds <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 是否为真聚合</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isReal <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 带文字的聚合图标</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMapLib<span class="token punctuation">.</span>TextIconOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;styles&quot;</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer<span class="token punctuation">.</span><span class="token function">getStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>Cluster</code>的方法就要精简得多，毕竟这个类并没有直接暴露出去：</p> <ul><li><code>addMarker</code>（向该聚合添加一个<code>marker</code>）</li> <li><code>isMarkerInCluster</code>（判断一个<code>marker</code>是否在该聚合中）</li> <li><code>updateGridBounds</code>(更新该聚合的网格范围)</li> <li><code>updateClusterMarker</code>(更新聚合点图标显示样式)</li> <li><code>getBounds</code>(获取该聚合所包含的所有<code>marker</code>的最小外接矩形范围)</li> <li><code>getCenter</code>（获取聚合的落脚点，即<code>_center</code>）</li> <li><code>isMarkerInClusterBounds</code>（判断<code>marker</code>是否在聚合网格范围中）</li> <li><code>remove</code>(删除该聚合)</li> <li><code>isReal</code>（获取<code>this._isReal</code>）</li></ul> <h2 id="排查bug"><a href="#排查bug" class="header-anchor">#</a> 排查bug</h2> <p>那么bug到底出在哪呢，这一次我们从点聚合的流程入手：</p> <ol><li>首先<code>MarkerClusterer</code>类的构造函数调用了<code>this.addMarkers(mkrs)</code></li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">var</span> MarkerClusterer <span class="token operator">=</span> BMapLib<span class="token punctuation">.</span><span class="token function-variable function">MarkerClusterer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//中间部分省略</span>
        <span class="token comment">//.....</span>
        <span class="token comment">//中间部分省略</span>

        <span class="token keyword">var</span> mkrs <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;markers&quot;</span><span class="token punctuation">]</span>
        <span class="token comment">// 学习：先做判断是不是数组，传入的参数很有必要做判断</span>
        <span class="token function">isArray</span><span class="token punctuation">(</span>mkrs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addMarkers</span><span class="token punctuation">(</span>mkrs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>将目光聚焦到<code>MarkerClusterer.prototype.addMarkers</code></li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addMarkers</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">markers</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>len <span class="token operator">=</span> markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_pushMarkerTo</span><span class="token punctuation">(</span>markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createClusters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="3"><li>然后看看<code>MarkerClusterer.protoType._pushMarkersTo</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_pushMarkerTo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        marker<span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>看起来这就是将<code>marker</code>添加到<code>this._markers</code>数组中的方法</p> <ol start="4"><li>那么继续看<code>MarkerClusterer.prototype._createClusters</code></li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code><span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_createClusters</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取地图可视区域，以地理坐标表示</span>
    <span class="token keyword">var</span> mapBounds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 扩展mapBounds</span>
    <span class="token keyword">var</span> extendedBounds <span class="token operator">=</span> <span class="token function">getExtendedBounds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">,</span> mapBounds<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_gridSize<span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span> marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果marker的isInCluster为false，证明该点没有被添加进去</span>
        <span class="token comment">// Bounds.containsPoint 如果点的地理坐标位于此矩形内，则返回true</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>marker<span class="token punctuation">.</span>isInCluster <span class="token operator">&amp;&amp;</span> extendedBounds<span class="token punctuation">.</span><span class="token function">containsPoint</span><span class="token punctuation">(</span>marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将点添加到最近的聚合中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addToClosestCluster</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>前面的代码都是各种判断，然后关键的步骤是<code>for循环</code>中的<code>this._addToClosestCluster(marker)</code></p> <ol start="5"><li>继续找到 <code>MarkerClusterer.prototype._addToClosestCluster</code></li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code><span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_addToClosestCluster</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 指定一个distance</span>
        <span class="token keyword">var</span> distance <span class="token operator">=</span> <span class="token number">4000000</span>
        <span class="token comment">// 将要添加进的聚合实例</span>
        <span class="token keyword">var</span> clusterToAddTo <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token comment">// 点的位置 地理坐标</span>
        <span class="token keyword">var</span> position <span class="token operator">=</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 遍历所有的聚合数组</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cluster<span class="token punctuation">;</span>cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取聚合的中心</span>
            <span class="token keyword">var</span> center <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// this._map.getDistance 返回两点之间的距离，单位是米</span>
                <span class="token comment">// 这里直接用position不就好了吗</span>
                <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span>center<span class="token punctuation">,</span> position<span class="token punctuation">)</span>
                <span class="token comment">// 400万米相当于山东青岛到新疆乌鲁木齐这么远,先给定一个较远的范围</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>d <span class="token operator">&lt;</span> distance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 找出距离最近的那个聚合</span>
                    distance <span class="token operator">=</span> d
                    clusterToAddTo <span class="token operator">=</span> cluster
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果点在该聚合的边界中就将该点添加进去</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>clusterToAddTo <span class="token operator">&amp;&amp;</span> clusterToAddTo<span class="token punctuation">.</span><span class="token function">isMarkerInClusterBounds</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            clusterToAddTo<span class="token punctuation">.</span><span class="token function">addMarker</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果不在就创建一个新聚合</span>
            <span class="token keyword">var</span> cluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cluster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            cluster<span class="token punctuation">.</span><span class="token function">addMarker</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>我的注释写的比较详细，总之能看到比较关键的下一步，应该是 <code>cluster.addMarker(marker)</code></p> <ol start="6"><li>继续看<code>Cluster.prototype.addMarker</code></li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果这个点原本就在该聚合中，就不再进行下一步</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isMarkerInCluster</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果没有_center属性则将center设置为第一个marker的坐标</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 更新聚合的网格边界</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateGridBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 因为加了一个点，所以需要加1</span>
                <span class="token keyword">var</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>markers<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token comment">// 计算平均纬度</span>
                <span class="token keyword">var</span> lat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">.</span>lat <span class="token operator">*</span> <span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">/</span> l
                <span class="token comment">// 计算平均经度</span>
                <span class="token keyword">var</span> lng <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">.</span>lng <span class="token operator">*</span> <span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lng<span class="token punctuation">)</span> <span class="token operator">/</span> l
                <span class="token comment">// 更新聚合网格边界</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>lng<span class="token punctuation">,</span> lat<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateGridBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        marker<span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>

        <span class="token keyword">var</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果markers的长度小于minClusterSize，就将marker直接添加到map中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addOverlay</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果markers的长度等于minClusterSize就遍历将之前添加到地图的marker全部移除，此处有效率低下卡顿的嫌疑</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 将_clusterMarker添加到地图上，此时上面的数量还是上次的，位置也是上次的</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isReal <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token comment">// 更新_clusterMarker显示</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateClusterMarker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>这个方法是在一个大循环中调用到的，因此会频繁的往地图上添加移除标注点，这里有效率低下导致卡顿的嫌疑，但是不至于会那么卡，我们接着看一下<code>this.updateClusterMarker()</code>里写了什么。</p> <ol start="7"><li><code>Cluster.prototype.updateClusterMarker</code></li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">updateClusterMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 当前地图的缩放级别是否大于最大聚合缩放级别</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">getZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer<span class="token punctuation">.</span><span class="token function">getMaxZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除地图上的聚合图标</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">)</span>
            <span class="token comment">// 将该聚合中的点添加到地图上</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span> marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addOverlay</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果markers的长度小于最小聚合数量，就将聚合图标隐藏起来</span>
            <span class="token comment">// 问题：隐藏起来了那这个聚合中的点怎么办</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新图标的位置和文字</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

        <span class="token keyword">var</span> thatMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map
        <span class="token keyword">var</span> thatBounds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//给点聚合标记绑定click事件,此处因多次绑定事件会造成卡顿</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置map的Viewport到合适的位置和尺寸</span>
            thatMap<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span>thatBounds<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>家人们！终于找到问题所在了啊,<code>updateClusterMarker</code>方法会被调用多次，那么<code>this._clusterMarker</code>上就会被绑定多次<code>click</code>事件，不卡就有鬼了啊！</p> <ol start="8"><li>解决问题
终于定位到问题位置了，怎么解决呢，非常简单，我们只需要在<code>Cluster</code>的构造函数中去绑定这个<code>click</code>事件就好了，这样就只会绑定一次</li></ol> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Cluster</span><span class="token punctuation">(</span><span class="token parameter">markerClusterer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 总聚合markerClusterer实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer <span class="token operator">=</span> markerClusterer
    <span class="token keyword">this</span><span class="token punctuation">.</span>_map <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">getMinClusterSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">isAverageCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 落脚位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 这个Cluster中所包含的markers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_markers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 以中心点为准，向四边扩大gridSize个像素范围，即网格范围</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_gridBounds <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 是否为真聚合</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isReal <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 带文字的聚合图标</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMapLib<span class="token punctuation">.</span>TextIconOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;styles&quot;</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer<span class="token punctuation">.</span><span class="token function">getStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 改为在此处绑定click事件</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> thatMap <span class="token operator">=</span> that<span class="token punctuation">.</span>_map
        <span class="token keyword">var</span> thatBounds <span class="token operator">=</span> that<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 设置map的Viewport到合适的位置和尺寸</span>
        thatMap<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span>thatBounds<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>再来看一下效果：
<img src="https://daodaoblogpicgo.oss-cn-shanghai.aliyuncs.com/img/2023091402.gif" alt="">
不卡了耶！！！！</p> <h2 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h2> <p>解决方式很简单，将原本引用的</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>改成下面的文件就好了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * write by 张舟 zhangzhou 2023/09/11
 * 为了解决百度地图点聚合点击聚合图标卡顿问题，重新写一遍并梳理流程
 */</span>

<span class="token comment">/**
 * @namespace BMap的所有library类均放在BMapLib命名空间下
 */</span>
<span class="token keyword">var</span> BMapLib <span class="token operator">=</span> window<span class="token punctuation">.</span>BMapLib <span class="token operator">=</span> BMapLib <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获取一个扩展的视图范围，把上下左右都扩大一样的像素值
     * @param {Map} map BMap.Map的实例化对象
     * @param {BMap.Bounds} bounds BMap.Bounds的实例化对象
     * @param {Number} gridSize 要扩大的像素值
     *
     * @return {BMap.Bounds} 返回扩大后的视图范围
     */</span>
     <span class="token keyword">var</span> <span class="token function-variable function">getExtendedBounds</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span>bounds<span class="token punctuation">,</span>gridSize</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">// 1.处理边界，让其边界符合百度地图规范</span>
         bounds <span class="token operator">=</span> <span class="token function">cutBoundsInRange</span><span class="token punctuation">(</span>bounds<span class="token punctuation">)</span>
         <span class="token comment">// bounds东北角像素坐标</span>
         <span class="token keyword">var</span> pixelNE <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">pointToPixel</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">getNorthEast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token comment">// bounds西南角像素坐标</span>
         <span class="token keyword">var</span> pixelSW <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">pointToPixel</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">getSouthWest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token comment">// 扩展像素坐标</span>
         pixelNE<span class="token punctuation">.</span>x <span class="token operator">+=</span> gridSize
         pixelNE<span class="token punctuation">.</span>y <span class="token operator">-=</span> gridSize
         pixelSW<span class="token punctuation">.</span>x <span class="token operator">-=</span> gridSize
         pixelSW<span class="token punctuation">.</span>y <span class="token operator">+=</span> gridSize
         <span class="token comment">// 计算新的东北角和西南角，并重新生成Bounds返回</span>
         <span class="token keyword">var</span> newNE <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">pixelToPoint</span><span class="token punctuation">(</span>pixelNE<span class="token punctuation">)</span>
         <span class="token keyword">var</span> newSW <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">pixelToPoint</span><span class="token punctuation">(</span>pixelSW<span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Bounds</span><span class="token punctuation">(</span>newSW<span class="token punctuation">,</span> newNE<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 按照百度地图支持的世界范围对bounds进行边界处理
     * @param {BMap.Bounds} bounds BMap.Bounds的实例化对象
     *
     * @return {BMap.Bounds} 返回不越界的视图范围
     */</span>
     <span class="token keyword">var</span> <span class="token function-variable function">cutBoundsInRange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">bounds</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// getNorthEast() 返回矩形区域的东北角</span>
         <span class="token keyword">var</span> maxX <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">getNorthEast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lng<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span>
         <span class="token keyword">var</span> minX <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">getSouthWest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lng<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span>
         <span class="token keyword">var</span> maxY <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">getNorthEast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">)</span>
         <span class="token keyword">var</span> minY <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">getSouthWest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">74</span><span class="token punctuation">,</span><span class="token number">74</span><span class="token punctuation">)</span>
        <span class="token comment">/**
         * Bounds(sw: Point, ne: Point)
         * 创建一个包含所有给定点坐标的矩形区域。其中sw表示矩形区域的西南角，参数ne表示矩形区域的东北角
         */</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Bounds</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>minX<span class="token punctuation">,</span>minY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>maxX<span class="token punctuation">,</span>maxY<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 对单个值进行边界处理
     * @param {Number} i 要处理的数值
     * @param {Number} min 下边界值
     * @param {Number} max 上边界值
     *
     * @return {Number} 返回不越界的数值
     */</span>
    <span class="token keyword">var</span> <span class="token function-variable function">getRange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> min<span class="token punctuation">,</span>max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// i值取i和min中较大的那一个，即i不可以超出min这个最小的边界</span>
        min <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// i值取i和max中较小的那一个，即i不可以超出max这个最大的边界</span>
        max <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> i
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断给定的对象是否为数组
     * @param {Object} source 要测试的对象
     * @return {Boolean} 如果是数组返回true,否则返回false
     */</span>
    <span class="token keyword">var</span> <span class="token function-variable function">isArray</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'[object Array]'</span> <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回item在source中的所以位置
     * @param {Object} item 要测试的对象
     * @param {Array} source 数组
     *
     * @return {Number} 如果在数组内，返回索引，否则返回 -1
     */</span>
    <span class="token keyword">var</span> <span class="token function-variable function">indexOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>indexOf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                index <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>m<span class="token punctuation">;</span>m <span class="token operator">=</span> source<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>m <span class="token operator">===</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        index <span class="token operator">=</span> i
                        <span class="token keyword">break</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> index
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * MarkerClusterer类
     * @class 用来解决加载大量点的问题，并提高性能
     * @param map 地图实例
     * @param options
     * options:{
     *  markers: Marker[] 要聚合的标记数组
     *  gridSize: Number 聚合计算时网格的像素大小，默认60
     *  maxZoom: Number 最大聚合级别，大于该级别就不进行相应的聚合
     *  minClusterSize: Number 最小的聚合数量，小于改数量的不能成为一个聚合，默认为2
     *  isAverangeCenter: Boolean 聚合点的落脚位置是否是所有聚合在内点的平均值，默认为否，落脚在聚合内的第一个点
     *  styles: IconStyle[] 自定义聚合后的图标风格，请参考TextIconOverlay类
     * }
     */</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;看看有没有BMapLib&quot;</span><span class="token punctuation">,</span>BMapLib<span class="token punctuation">)</span>
    <span class="token keyword">var</span> MarkerClusterer <span class="token operator">=</span> BMapLib<span class="token punctuation">.</span><span class="token function-variable function">MarkerClusterer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// map实例必传</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 地图实例</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map <span class="token operator">=</span> map
        <span class="token comment">// 普通点集合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">// 点聚合集合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment">// 处理一下传过来的参数</span>
        <span class="token keyword">var</span> opts <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_gridSize <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;gridSize&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">60</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_maxZoom <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;maxZoom&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">18</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;minClusterSize&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">[</span><span class="token string">&quot;isAverageCenter&quot;</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;isAverageCenter&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_styles <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;styles&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>

        <span class="token comment">// 监听地图 zoomend 事件和 moveend 事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;zoomend&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
            that<span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;moveend&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            that<span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">var</span> mkrs <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token string">&quot;markers&quot;</span><span class="token punctuation">]</span>
        <span class="token comment">// 学习：先做判断是不是数组，传入的参数很有必要做判断</span>
        <span class="token function">isArray</span><span class="token punctuation">(</span>mkrs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addMarkers</span><span class="token punctuation">(</span>mkrs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 添加要聚合的标记数组
     * @param {Array&lt;Marker&gt;} markers 要聚合的标记数组
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addMarkers</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">markers</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>len <span class="token operator">=</span> markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_pushMarkerTo</span><span class="token punctuation">(</span>markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createClusters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 把一个标记添加到要聚合的标记数组中
     * @param {BMap.Marker} marker 要添加的标记
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_pushMarkerTo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            marker<span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 添加一个聚合的标记
     * @param {BMap.Marker} marker 要聚合的单个标记
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_pushMarkerTo</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createClusters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据所给定的标记，创建聚合点
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_createClusters</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取地图可视区域，以地理坐标表示</span>
        <span class="token keyword">var</span> mapBounds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 扩展mapBounds</span>
        <span class="token keyword">var</span> extendedBounds <span class="token operator">=</span> <span class="token function">getExtendedBounds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">,</span> mapBounds<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_gridSize<span class="token punctuation">)</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span> marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果marker的isInCluster为false，证明该点没有被添加进去</span>
            <span class="token comment">// Bounds.containsPoint 如果点的地理坐标位于此矩形内，则返回true</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>marker<span class="token punctuation">.</span>isInCluster <span class="token operator">&amp;&amp;</span> extendedBounds<span class="token punctuation">.</span><span class="token function">containsPoint</span><span class="token punctuation">(</span>marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将点添加到最近的聚合中</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addToClosestCluster</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据marker的位置，把它添加到最近的聚合中
     * @param {BMap.Marker} marker 要进行聚合的单个marker
     *
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_addToClosestCluster</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 指定一个distance</span>
        <span class="token keyword">var</span> distance <span class="token operator">=</span> <span class="token number">4000000</span>
        <span class="token comment">// 将要添加进的聚合实例</span>
        <span class="token keyword">var</span> clusterToAddTo <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token comment">// 点的位置 地理坐标</span>
        <span class="token keyword">var</span> position <span class="token operator">=</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 遍历所有的聚合数组</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cluster<span class="token punctuation">;</span>cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取聚合的中心</span>
            <span class="token keyword">var</span> center <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// this._map.getDistance 返回两点之间的距离，单位是米</span>
                <span class="token comment">// 这里直接用position不就好了吗</span>
                <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span>center<span class="token punctuation">,</span> position<span class="token punctuation">)</span>
                <span class="token comment">// 400万米相当于山东青岛到新疆乌鲁木齐这么远,先给定一个较远的范围</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>d <span class="token operator">&lt;</span> distance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 找出距离最近的那个聚合</span>
                    distance <span class="token operator">=</span> d
                    clusterToAddTo <span class="token operator">=</span> cluster
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果点在该聚合的边界中就将该点添加进去</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>clusterToAddTo <span class="token operator">&amp;&amp;</span> clusterToAddTo<span class="token punctuation">.</span><span class="token function">isMarkerInClusterBounds</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            clusterToAddTo<span class="token punctuation">.</span><span class="token function">addMarker</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果不在就创建一个新聚合</span>
            <span class="token keyword">var</span> cluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cluster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            cluster<span class="token punctuation">.</span><span class="token function">addMarker</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取聚合的Map实例
     * @return {Map} Map的实例
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getMap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取单个聚合的最小数量
     * @return {Number} 单个聚合的最小数量
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getMinClusterSize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置单个聚合的最小数量
     * @param {Number} size 单个聚合的最小数量
     *
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setMinClusterSize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize <span class="token operator">=</span> size
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取单个聚合的落脚点是否是聚合内所有标记的平均中心
     * @return {Boolean} true 或 false
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">isAverageCenter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取聚合的样式风格集合
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getStyles</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_styles
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置聚合的样式风格集合
     * @param {Array&lt;IconStyle&gt;} styles 样式风格数组
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setStyles</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">styles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_styles <span class="token operator">=</span> styles
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取聚合的最大缩放级别
     *
     * @return {Number} 聚合的最大缩放级别
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getMaxZoom</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_maxZoom
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置聚合的最大缩放级别
     * @param {Number} maxZoom 聚合的最大缩放级别
     *
     * @return false
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setMaxZoom</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">maxZoom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_maxZoom <span class="token operator">=</span> maxZoom
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取网格大小
     * @return {Number} 网格大小
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getGridSize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_gridSize
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置网格大小
     * @param {Number} Size 网格大小
     *
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setGridSize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_gridSize <span class="token operator">=</span> size
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 重新生成, 比如改变了属性等
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_redraw</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_clearLastClusters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createClusters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 清除上一次的聚合的结果
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_clearLastClusters</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历_cluster数组，调用cluster的remove方法</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>cluster<span class="token punctuation">;</span>cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cluster<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeMarkersFromCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 清除聚合中的所有标志位
     *
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_removeMarkersFromCluster</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span>marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            marker<span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从地图上彻底清除所有标记
     *
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">clearMarkers</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 清除上一次的聚合结果</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_clearLastClusters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 将地图上的散点清除掉</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeMarkersFromMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 把所有的marker从地图上清除
     * @return 无返回值
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_removeMarkersFromMap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span>marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            marker<span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从地图和数据层面删除单个marker
     * @param {BMap.Marker} marker 需要被删除的marker
     *
     * @return {Boolean} 删除成功返回true,否则返回false
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_removeMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOlerlay</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除单个marker并重绘聚合
     * * @param {BMap.Marker} marker 需要被删除的marker
     *
     * @return {Boolean} 删除成功返回true，否则返回false
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">removeMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeMarker</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> success
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除一组marker
     * @param {Array&lt;BMap.Marker&gt;} markers 需要被删除的marker数组
     *
     * @return {Boolean} 删除成功返回true，否则返回false
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">removeMarkers</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">markers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeMarker</span><span class="token punctuation">(</span>markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            success <span class="token operator">=</span> success <span class="token operator">||</span> r
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> success
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取所以的标记数组
     * @return {Array&lt;Marker&gt;} 标记数组
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getMarkers</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取聚合的总数量
     * @return {Number} 聚合的总数量
     */</span>
    <span class="token class-name">MarkerClusterer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getClustersCount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>cluster<span class="token punctuation">;</span>cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clusters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cluster<span class="token punctuation">.</span><span class="token function">isReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> count<span class="token operator">++</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> count
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Cluster
     * @class 表示一个聚合对象，该聚合，包含有N个marker，这N个marker组成的范围，并有予以显示在Map上的TextIconOverlay
     * @constructor
     * @param {MarkerClusterer} markerClusterer 聚合实例
     */</span>
    <span class="token keyword">function</span> <span class="token function">Cluster</span><span class="token punctuation">(</span><span class="token parameter">markerClusterer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 总聚合markerClusterer实例</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer <span class="token operator">=</span> markerClusterer
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">getMinClusterSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter <span class="token operator">=</span> markerClusterer<span class="token punctuation">.</span><span class="token function">isAverageCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 落脚位置</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token comment">// 这个Cluster中所包含的markers</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">// 以中心点为准，向四边扩大gridSize个像素范围，即网格范围</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_gridBounds <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token comment">// 是否为真聚合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isReal <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 带文字的聚合图标</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMapLib<span class="token punctuation">.</span>TextIconOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;styles&quot;</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer<span class="token punctuation">.</span><span class="token function">getStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 改为在此处绑定click事件</span>
        <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> thatMap <span class="token operator">=</span> that<span class="token punctuation">.</span>_map
            <span class="token keyword">var</span> thatBounds <span class="token operator">=</span> that<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 设置map的Viewport到合适的位置和尺寸</span>
            thatMap<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span>thatBounds<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 向该聚合添加一个标记
     * @param {Marker} marker 要添加的标记
     * @return {Boolean}
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果这个点原本就在该聚合中，就不再进行下一步</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isMarkerInCluster</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果没有_center属性则将center设置为第一个marker的坐标</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 更新聚合的网格边界</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateGridBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isAverageCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 因为加了一个点，所以需要加1</span>
                <span class="token keyword">var</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>markers<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token comment">// 计算平均纬度</span>
                <span class="token keyword">var</span> lat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">.</span>lat <span class="token operator">*</span> <span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">/</span> l
                <span class="token comment">// 计算平均经度</span>
                <span class="token keyword">var</span> lng <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">.</span>lng <span class="token operator">*</span> <span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lng<span class="token punctuation">)</span> <span class="token operator">/</span> l
                <span class="token comment">// 更新聚合网格边界</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_center <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>lng<span class="token punctuation">,</span> lat<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateGridBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        marker<span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>

        <span class="token keyword">var</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果markers的长度小于minClusterSize，就将marker直接添加到map中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addOverlay</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果markers的长度等于minClusterSize就遍历将之前添加到地图的marker全部移除，此处有效率低下卡顿的嫌疑</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 将_clusterMarker添加到地图上，此时上面的数量还是上次的，位置也是上次的</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isReal <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateClusterMarker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断一个标记是否在该聚合中
     * @param {Marker} marker 要判断的标记
     *
     * @return {Boolean} true或false
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">isMarkerInCluster</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新该聚合的网格范围
     *
     * @return 无返回值
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">updateGridBounds</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置初始的边界，位置仅仅包含this._center这个点</span>
        <span class="token keyword">var</span> bounds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Bounds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">)</span>
        <span class="token comment">// 将网格上下所有扩大gridSize像素</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_gridBounds <span class="token operator">=</span> <span class="token function">getExtendedBounds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">,</span> bounds<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer<span class="token punctuation">.</span><span class="token function">getGridSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新该聚合的显示样式，也即TextIconOverlay
     * @return 无返回值
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">updateClusterMarker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 当前地图的缩放级别是否大于最大聚合缩放级别</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">getZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markerClusterer<span class="token punctuation">.</span><span class="token function">getMaxZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除地图上的聚合图标</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">)</span>
            <span class="token comment">// 将该聚合中的点添加到地图上</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span> marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">addOverlay</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_minClusterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果markers的长度小于最小聚合数量，就将聚合图标隐藏起来</span>
            <span class="token comment">// 问题：隐藏起来了那这个聚合中的点怎么办</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新图标的位置和文字</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

        <span class="token comment">// var thatMap = this._map</span>
        <span class="token comment">// var thatBounds = this.getBounds()</span>
        <span class="token comment">// 给点聚合标记绑定click事件,此处因多次绑定事件会造成卡顿</span>
        <span class="token comment">// this._clusterMarker.addEventListener(&quot;click&quot;,function(event) {</span>
        <span class="token comment">//     // 设置map的Viewport到合适的位置和尺寸</span>
        <span class="token comment">//     thatMap.setViewport(thatBounds)</span>
        <span class="token comment">// })</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取该聚合所包含的所有marker的最小外接矩形范围
     *
     * @return {BMap.Bounds} 计算出的范围
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getBounds</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> bounds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BMap<span class="token punctuation">.</span>Bounds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_center<span class="token punctuation">)</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>marker<span class="token punctuation">;</span>marker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 放大此矩形，使其包含给定的点</span>
            bounds<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bounds
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取该聚合的落脚点
     * @return {BMap.Point} 该聚合的落脚点
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getCenter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_center
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断一个标记是否在聚合网格范围中
     * @param {Marker} marker 要判断的标记
     *
     * @return {Boolean} true或false
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">isMarkerInClusterBounds</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_gridBounds<span class="token punctuation">.</span><span class="token function">containsPoint</span><span class="token punctuation">(</span>marker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除该聚合
     * @return 无返回值
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 清除散点</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>m<span class="token punctuation">;</span>m <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将所有点的isInCluster改为false</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>isInCluster <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 清除掉聚合标记</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">removeOverlay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_clusterMarker<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_markers<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_markers
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取该聚合是否为真聚合
     *
     * @return {Boolean}
     */</span>
    <span class="token class-name">Cluster</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">isReal</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">marker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_isReal
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br><span class="line-number">622</span><br><span class="line-number">623</span><br><span class="line-number">624</span><br><span class="line-number">625</span><br><span class="line-number">626</span><br><span class="line-number">627</span><br><span class="line-number">628</span><br><span class="line-number">629</span><br><span class="line-number">630</span><br><span class="line-number">631</span><br><span class="line-number">632</span><br><span class="line-number">633</span><br><span class="line-number">634</span><br><span class="line-number">635</span><br><span class="line-number">636</span><br><span class="line-number">637</span><br><span class="line-number">638</span><br><span class="line-number">639</span><br><span class="line-number">640</span><br><span class="line-number">641</span><br><span class="line-number">642</span><br><span class="line-number">643</span><br><span class="line-number">644</span><br><span class="line-number">645</span><br><span class="line-number">646</span><br><span class="line-number">647</span><br><span class="line-number">648</span><br><span class="line-number">649</span><br><span class="line-number">650</span><br><span class="line-number">651</span><br><span class="line-number">652</span><br><span class="line-number">653</span><br><span class="line-number">654</span><br><span class="line-number">655</span><br><span class="line-number">656</span><br><span class="line-number">657</span><br><span class="line-number">658</span><br><span class="line-number">659</span><br><span class="line-number">660</span><br><span class="line-number">661</span><br><span class="line-number">662</span><br><span class="line-number">663</span><br><span class="line-number">664</span><br><span class="line-number">665</span><br><span class="line-number">666</span><br><span class="line-number">667</span><br><span class="line-number">668</span><br><span class="line-number">669</span><br><span class="line-number">670</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Ostask/daodao-knowledge/edit/master/docs/工作琐碎/01.bug记录/09.百度地图点聚合点击事件卡顿问题解决.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/daodao-knowledge/pages/c0291f/" class="prev">
        canvas动画越来越卡顿解决
      </a></span> <span class="next"><a href="/daodao-knowledge/pages/5e5a48/">
        canvas绘制网络图片执行toDataURL()报错
      </a>
      →
    </span></p></div>  <div class="footer">
    MIT Licensed | Copyright © 2021-present 刀刀
  </div></main></div><div class="global-ui"></div></div>
    <script src="/daodao-knowledge/assets/js/app.b053aef9.js" defer></script><script src="/daodao-knowledge/assets/js/8.169c5c8d.js" defer></script><script src="/daodao-knowledge/assets/js/9.d9308caa.js" defer></script><script src="/daodao-knowledge/assets/js/134.0fe7afbd.js" defer></script>
  </body>
</html>
