---
title: 学黄轶老师vue3音乐APP(6-10章)
date: 2021-12-23 13:39:15
permalink: /pages/815447/
categories:
  - vue3
tags:
    -
---
## 第六章 歌单详情页与排行榜页面开发
歌单详情页和排行榜详情页还有歌手详情页的页面和功能都几乎是一样的，只是数据不太一样，所以一样的功能不要写重复的代码，可以把之前写好的singer-detail组件封装一下：

```js
// create-detail-components.js

import MusicList from '@/components/music-list/music-list'
import storage from 'good-storage'
import { processSongs } from '@/service/song'

export default function createDetailComponent(name, key, fetch) {
    return {
        name,
        components: { MusicList },
        props: {
            data: Object
        },
        data() {
            return {
                songs: [],
                loading: true
            }
        },
        computed: {
            computedData() {
                let ret = null
                const data = this.data
                if (data) {
                    ret = data
                } else {
                    const cachedData = storage.session.get(key)
                    if (cachedData && (cachedData.mid || cachedData.id + '') === this.$route.params.id) {
                        ret = cachedData
                    }
                }
                return ret
            },
            pic() {
                const data = this.computedData
                return data && data.pic
            },
            title() {
                const data = this.computedData
                return data && (data.name || data.title)
            }
        },
        async created() {
            const data = this.computedData
            if (!data) {
                const path = this.$route.matched[0].path
                this.$router.push(path)
                return
            }
            const result = await fetch(data)
            this.songs = await processSongs(result.songs)
            this.loading = false
        }
    }
}

```
这三个组件不同的地方只有name, key, fetch三处，所以改完之后的singer-detail组件应该是这样：
```vue
<template>
    <div class="singer-detail">
        <music-list
            :songs = "songs"
            :title = "title"
            :pic = "pic"
            :loading="loading"
        ></music-list>
    </div>
</template>

<script>
    import createDetailComponent from '@/assets/js/create-detail-component'
    import { getSingerDetail } from '@/service/singer'
    import { SINGER_KEY } from '@/assets/js/constant'

    export default createDetailComponent('singer-detail', SINGER_KEY, getSingerDetail)
</script>

<style lang="scss" scoped>
    .singer-detail {
        position: fixed;
        z-index: 10;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: $color-background;
    }
</style>
```
剩下的歌单详情页与排行榜详情组件也类似这样去写。

::: warning 黄老师强调多次的
- 重复的东西不要写重复的代码，要考虑封装
- 响应式数据在同一个函数内访问超过两次的，要用变量先存储，不然效率会很低下，经历多次依赖收集
:::

## 第七章 搜索页面开发
### 搜索输入框组件
默认情况下，组件上的 `v-model` 使用 `modelValue` 作为 `prop` 和 `update:modelValue` 作为事件。我们可以通过向 `v-model` 传递参数来修改这些名称。所以自定义的输入框组件应该这样封装：
```vue
<template>
    <div class="search-input">
        <input
            class="input-inner"
            v-model="query"
        />
    </div>
</template>

<script>
export default {
    name: 'search-input',
    props: {
        modelValue: String
    },
    data() {
        return {
            query: this.modelValue
        }
    },
    watch: {
        query(newQuery) {
            this.$emit('update:modelValue', newQuery)
        }
    }
}
</script>
```
#### 防抖
输入框输入应该有个防抖功能，当连续输入的时候，延缓300ms再触发`update:modelValue`事件。节流用了第三方库`throttle-debounce`,使用这个第三方库需要使用$watch方法，不然内部this指向会有问题,同时监听`modelValue`的值，实现真正的双向绑定。

```js {14-20}
import { debounce } from 'throttle-debounce'

export default {
    name: 'search-input',
    props: {
        modelValue: String
    },
    data() {
        return {
            query: this.modelValue
        }
    },
    created() {
        this.$watch('query', debounce(300, (newQuery) => {
            this.$emit('update:modelValue', newQuery.trim())
        }))

        this.$watch('modelValue', (newVal) => {
            this.query = newVal
        })
    },
    methods: {
        clear() {
            this.query = ''
        }
    }
}
```

### 上拉加载
上拉加载使用的是`@better-scroll/pull-up`,需要注意的是，从数据到dom变化，需要`await nextTick()`千万要注意！！

这个教程因为过滤了一些付费歌曲，所以请求到的歌曲有时候不足一屏，这种情况下想要用户体验好点可以多请求几次接口：
```js
async function searchMore() {
    // 如果没有更多歌曲了就不请求了
    if (!hasMore.value) {
        return
    }
    page.value++
    //请求数据
    const result = await search(props.query, page.value, props.showSinger)
    songs.value = songs.value.concat(await processSongs(result.songs))
    singer.value = result.singer
    hasMore.value = result.hasMore
    //一定要await nextTick!!!
    await nextTick()
    //判断需不需要再请求
    await makeItScrollMore()
}

async function makeItScrollMore() {
    // 判断能不能滚动，不能就再加载
    if (scroll.value.maxScrollY >= -1) {
        await searchMore()
    }
}
```

## 第八章 添加歌曲与用户中心页面开发