---
title: 学黄轶老师vue3音乐APP(第5章)
date: 2021-12-21 10:45:09
permalink: /pages/1ab44e/
categories:
  - vue3
tags:
    -
---
这一章是开发音乐APP的播放器部分，包括全屏的播放器和缩小的迷你播放器，以及进度条，歌词滚动，唱片动画，切歌，播放列表等等。

## audio的使用
我们使用原生audio元素，然后再用js去控制这个元素。那么这个元素有哪些是值得我们注意的呢：

### audio对象属性
|  属性   |  描述  |
|  ----  | ----  |
| currentTime  | 设置或返回音频中的当前播放位置（以秒计）。 |
| duration  | 返回音频的长度（以秒计）。 |
| paused  | 设置或返回音频是否暂停。 |
| src | 设置或返回音频的 src 属性的值。 |
| volume | 设置或返回音频的音量。 |

### audio对象方法
| 方法 |  描述 |
| ---- | ------ |
| play() | 开始播放音频。 |
| pause() | 暂停当前播放的音频。 |

### audio对象事件
| 事件名称 | 触发时机 |
| ------- | -------- |
| canplay | 浏览器已经可以播放媒体，但是预测已加载的数据不足以在不暂停的情况下顺利将其播放到结尾（即预测会在播放时暂停以获取更多的缓冲区内容）|
| ended | 播放到媒体的结束位置，播放停止。 |
| pause | 播放暂停。 |
| timeupdate | 由 currentTime 指定的时间更新。 |

整个播放的逻辑应该是这样的：
1. 通过接口获取到歌曲的src，将audio的src属性设置好
2. audio对象的canplay事件触发后，就可以播放歌曲了
3. audio对象的timeupdate事件中更新自己写的进度条的进度
4. 使用play() 和 pause() 来播放暂停歌曲

## 播放器组件基础功能
编写player组件，这个组件中包含全屏的大播放器，和迷你的小播放器，以及audio标签。将这个player组件应用到App.vue中，因为播放器是全局所有页面都可以使用的。
```vue {5}
<template>
  <m-header></m-header>
  <tab></tab>
  <router-view :style="viewStyle"></router-view>
  <player></player>
</template>
```

### store设计
`state`中定义了如下数据：
```js 
// state.js
// 将一些常量写在一个文件中方便维护
import { PLAY_MODE, FAVORITE_KEY } from '@/assets/js/constant' 
// load方法是一个从storage中读取数组的方法
import { load } from '@/assets/js/array-store'

const state = {
    sequenceList: [], // 原始歌曲顺序列表
    playList: [], // 真实的播放列表
    playing: false, //歌曲是否在播放
    playMode: PLAY_MODE.sequence, //歌曲播放模式
    currentIndex: 0, //当前播放的歌曲在播放列表中的索引
    fullScreen: false, // 播放器是否全屏
    favoriteList: load(FAVORITE_KEY) //收藏的歌曲列表，会存到storage中
}

export default state
```

```js
// getters.js
export const currentSong = (state) => {
  //这个地方做一下保护，如果没有playList的话就返回一个空对象，以免模板报错
    return state.playList[state.currentIndex] || {} 
}
```

这里学到的操作有：
1. 一些常量要学会写在同一个文件中，这样会比较好维护，比如：
```js
export const SINGER_KEY = '__singer__'
export const FAVORITE_KEY = '__favorite__'

export const PLAY_MODE = {
    sequence: 0,
    loop: 1,
    random: 2
}
```

### 播放歌曲
点击了歌曲之后，将歌曲的索引更新到 `currentIndex` ，然后`currentSong`就会发生改变，然后将`audio`的`src`设置为`currentSong`的`src`,然后调用`audio`对象的`play()`方法,歌曲就可以播放了。  

如何在setup中使用vuex呢： 
```js
import { useStore } from 'vuex'
import { computed } from 'vue'
const store = useStore()
const currentSong = computed(() => store.getters.currentSong)
``` 
使用`computed`来获取`currentSong`的数据，以此来保证`currentSong`的数据是响应式的。

### 播放暂停歌曲
先给audio绑定`canplay`事件，在这个事件回调中将`songReady`这个标志位置为`true`,用来保证歌曲播放不会因为资源没有加载报错。  
player组件的播放/暂停按钮绑定`togglePlay()`方法
```js
function togglePlay() {
    if (!songReady.value) { 
        return
    }
    store.commit('setPlayingState', !playing.value)
}
```
然后watch一下playing的状态，当playing为true时播放歌曲，当playing为false时暂停歌曲：
```js
watch(playing, (newPlaying) => {
    if (!songReady.value) {
        return
    }
    const audioEl = audioRef.value
    if (newPlaying) {
        audioEl.play()
        playLyric()
    } else {
        audioEl.pause()
        stopLyric()
    }
})
```